---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Review of Schools and Programmes of Public Health

<!-- badges: start -->
[![Project Status: Active – The project has reached a stable, usable state and is being actively developed.](https://www.repostatus.org/badges/latest/active.svg)](https://www.repostatus.org/#active)
[![test targets workflow](https://github.com/OxfordIHTM/spph-review/actions/workflows/test-targets-workflow.yml/badge.svg)](https://github.com/OxfordIHTM/spph-review/actions/workflows/test-targets-workflow.yml)
[![License for code](https://img.shields.io/badge/license (for code)-GPL3.0-blue.svg)](https://opensource.org/licenses/gpl-3.0.html)
[![License for text](https://img.shields.io/badge/license (for writing)-CC_BY_4.0-blue)](https://creativecommons.org/licenses/by/4.0/)
[![License for data](https://img.shields.io/badge/license (for data)-CC0-blue)](https://creativecommons.org/public-domain/cc0/)
<!-- badges: end -->

This repository is a template for a [`docker`](https://www.docker.com/get-started)-containerised, [`{targets}`](https://docs.ropensci.org/targets/)-based, [`{renv}`](https://rstudio.github.io/renv/articles/renv.html)-enabled [`R`](https://cran.r-project.org/) workflow for the **Review of Schools and Programmes of Public Health project**.

## About the Project



## Repository Structure

The project repository is structured as follows:

```
spph-review
    |-- .github/
    |-- data/
    |-- data-raw/
    |-- figures/
    |-- outputs/
    |-- R/
    |-- renv
    |-- reports
    |-- _targets_analysis.R
    |-- _targets_data.R
    |-- _targets_output.R
    |-- _targets_rag.R
    |-- _targets_release.R
    |-- _targets.R
    |-- .Rprofile
    |-- packages.R
    |-- renv.lock
```

* `.github` contains project testing and automated deployment of outputs workflows via continuous integration and continuous deployment (CI/CD) using Github Actions.

* `data/` contains intermediate and final data outputs produced by the workflow.

* `data-raw/` contains raw datasets, usually either downloaded from source or added manually, that are used in the project.

* `figures/` contains figures produced by the workflow.

* `outputs/` contains compiled reports produced by the workflow.

* `R/` contains functions developed/created specifically for use in this workflow.

* `renv/` contains `renv` package specific files and directories used by the package for maintaining R package dependencies within the project. The directory `renv/library`, is a library that contains all packages currently used by the project. This directory, and all files and sub-directories within it, are all generated and managed by the `renv` package. Users should not change/edit these manually.

* `reports/` contains literate code for R Markdown and/or Quarto reports rendered in the workflow.

* `_targets*.R` files define the steps in the workflow’s data ingest, data processing, data analysis, and reporting pipelines.

* `.Rprofile` file is a project R profile generated when initiating `renv` for the first time. This file is run automatically every time R is run within this project, and `renv` uses it to configure the R session to use the `renv` project library.

* `packages.R` file lists out all R package dependencies required by the workflow.

* `renv.lock` file is the `renv` lockfile which records enough metadata about every package used in this project that it can be re-installed on a new machine. This file is generated by the `renv` package and should not be changed/edited manually.


## Reproducibility

### System dependencies

This project requires the following system dependencies:

* `poppler`

This project depends on the [`{pdftools}`](https://poppler.freedesktop.org/) package which requires the `poppler` PDF rendering library to be installed first. For macOS and Windows users, installation of `{pdftools}` via the binary packages available from CRAN will deal with this requirement automatically. However, for Linux users, the `poppler` library will need to be installed first in order to be able to install `{pdftools}` from source. Installation of the `poppler` library for Linux is described [here](https://docs.ropensci.org/pdftools/#installation).

* `quarto`

This project uses the [`quarto`](https://quarto.org/) open-source scientific and technical publishing system. Instructions on how to download and install `quarto` can be found [here](https://quarto.org/docs/get-started/).

* `ollama`

This project uses `ollama` to serve open large language modles (LLM) locally. Instructions on how to download and install `ollama` can be found [here](https://ollama.com/download). This project specifically uses the open source `DeepSeek-R1` model. Once `ollama` is installed, pull one of the `DeepSeek-R1` models that fits into your local machine. The workflow has been developed and implemented using the `deepseek-r1:671b` model which requires about 404GB of random access memory (RAM). We would recommend using the same model where possible or if your machine has enough memory resources.

### R package dependencies

This project was built using `R 4.5.1`. This project uses the `renv` framework to record R package dependencies and versions. Packages and versions used are recorded in `renv.lock` and code used to manage dependencies is in `renv/` and other files in the root project directory. After cloning this repository, start an R session in the project’s working directory and then run

```R
renv::restore()
```

to install all R package dependencies.

### Running the workflow

Currently, the project has workflows for the following:

1. Extraction, transformation, and loading (ETL) workflow for the [Association of Schools and Programs of Public Health (ASPPH)](https://aspph.org/) and [Association of Schools of Public Health in the European Region (ASPHER)](https://www.aspher.org/) members list.

The following diagram illustrates this pipeline.

```{r association-data-workflow, echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
cat(
  "```mermaid",
  suppressWarnings(
    targets::tar_mermaid(
      targets_only = TRUE, 
      names = dplyr::starts_with(c("aspph", "aspher")),
      color = FALSE, legend = FALSE,
      reporter = "silent"
    )
  ),
  "```",
  sep = "\n"
)
```

To run this workflow, issue the following command on the R console:

```R
targets::tar_make(dplyr::starts_with(c("aspph", "aspher")))
```

2. Extraction, transformation, and loading (ETL) workflow for the [Times Higher Education (THE) university rankings](https://www.timeshighereducation.com/), [QS world university rankings](https://www.topuniversities.com/), and the [ShanghaiRanking](https://www.shanghairanking.com/) academic ranking of world universities.

The following diagram illustrates this pipeline.

```{r ranking-data-workflow, echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
cat(
  "```mermaid",
  targets::tar_mermaid(
    targets_only = TRUE, 
    names = dplyr::starts_with(c("the", "qs", "sr")),
    color = FALSE, legend = FALSE,
    reporter = "silent"
  ),
  "```",
  sep = "\n"
)
```

To run this workflow, issue the following command on the R console:

```R
targets::tar_make(dplyr::starts_with(c("the", "qs", "sr")))
```

3. Workflow for the creation of knowledge store of schools and programmes of public health for Retrieval augmentation generation (RAG)

The following diagram illustrates this pipeline.

```{r schools-data-workflow, echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
cat(
  "```mermaid",
  targets::tar_mermaid(
    targets_only = TRUE, 
    names = c(
      ph_master_programme_links,
      ph_master_programme_list_csv,
      ph_review_data_processed_csv,
      ph_review_data_released 
    ),
    color = FALSE, legend = FALSE,
    reporter = "silent"
  ),
  "```",
  sep = "\n"
)
```

To run this workflow, issue the following command on the R console:

```R
targets::tar_make(
  dplyr::contains("ph_master_programme", "ph_review_data")
)
```


## License

All code in this project is released under a [GPL-3.0](https://www.gnu.org/licenses/gpl-3.0.en.html#license-text) license. All text in this project is released under a [CC-BY-4.0](https://creativecommons.org/licenses/by/4.0/deed.en) license. All data is released under a [CC0](https://creativecommons.org/public-domain/cc0/) license.


## Citation

If you use this workflow and/or the datasets within this project in your work/research, please cite `spph-review` along with all the sources of data that were used for curating the data available herewith. The suggested appropriate citation metadata is provided in [CITATION.cff](https://github.com/OxfordIHTM/spph-review/blob/main/CITATION.cff).

## Community guidelines

Feedback, bug reports and feature requests are welcome; file issues or seek support [here](https://github.com/OxfordIHTM/spph-review/issues). If you would like to contribute to the project, please see our [contributing guidelines](https://github.com/OxfordIHTM/spph-review/blob/main/.github/CONTRIBUTING.md).

This project is released with a [Contributor Code of Conduct](https://github.com/OxfordIHTM/spph-review/blob/main/.github/CODE_OF_CONDUCT.md). By participating in this project you agree to abide by its terms.

